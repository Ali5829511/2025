# Makefile for Traffic Violations Management System
# ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿßŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ±Ÿäÿ©

.PHONY: help install init-db run run-dev run-prod test clean docker-build docker-run docker-stop health check

# Default target
help:
	@echo "=========================================="
	@echo "üöÄ Traffic Violations Management System"
	@echo "=========================================="
	@echo ""
	@echo "Available commands:"
	@echo ""
	@echo "  make install      - Install dependencies"
	@echo "  make init-db      - Initialize database"
	@echo "  make run          - Run in production mode (Gunicorn)"
	@echo "  make run-dev      - Run in development mode (Flask)"
	@echo "  make test         - Run health check tests"
	@echo "  make health       - Quick health check"
	@echo "  make check        - Check system status"
	@echo "  make clean        - Clean temporary files"
	@echo "  make docker-build - Build Docker image"
	@echo "  make docker-run   - Run with Docker Compose"
	@echo "  make docker-stop  - Stop Docker containers"
	@echo ""

# Install dependencies
install:
	@echo "üì¶ Installing dependencies..."
	@pip install -q flask flask-cors python-dotenv requests pillow gunicorn colorama
	@echo "‚úÖ Dependencies installed"

# Initialize database
init-db:
	@echo "üóÑÔ∏è  Initializing database..."
	@python3 init_traffic_db.py
	@echo "‚úÖ Database initialized"

# Run in production mode
run:
	@echo "üöÄ Starting server in production mode..."
	@PORT=10000 gunicorn --config gunicorn_traffic_config.py traffic_app:app

# Run in development mode
run-dev:
	@echo "üöÄ Starting server in development mode..."
	@PORT=10000 python3 traffic_app.py

# Run production mode with custom port
run-prod:
	@echo "üöÄ Starting server in production mode on port $(PORT)..."
	@gunicorn --config gunicorn_traffic_config.py traffic_app:app

# Run tests
test:
	@echo "üß™ Running health check tests..."
	@python3 test_traffic_health.py http://localhost:10000

# Quick health check
health:
	@echo "üè• Checking system health..."
	@curl -s http://localhost:10000/health | python3 -m json.tool || echo "‚ùå Server not running"

# Check system status
check:
	@echo "üìä System Status Check"
	@echo "======================"
	@echo ""
	@echo "Python version:"
	@python3 --version
	@echo ""
	@echo "Gunicorn installed:"
	@which gunicorn || echo "‚ùå Not installed"
	@echo ""
	@echo "Database exists:"
	@test -f traffic.db && echo "‚úÖ traffic.db found" || echo "‚ùå traffic.db not found"
	@echo ""
	@echo "Server running:"
	@curl -s http://localhost:10000/health > /dev/null && echo "‚úÖ Server is running" || echo "‚ùå Server not running"

# Clean temporary files
clean:
	@echo "üßπ Cleaning temporary files..."
	@find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type f -name "*.log" -delete 2>/dev/null || true
	@echo "‚úÖ Cleanup complete"

# Build Docker image
docker-build:
	@echo "üê≥ Building Docker image..."
	@docker build -f Dockerfile.traffic -t traffic-violations-system:latest .
	@echo "‚úÖ Docker image built"

# Run with Docker Compose
docker-run:
	@echo "üê≥ Starting with Docker Compose..."
	@docker-compose -f docker-compose.traffic-standalone.yml up -d
	@echo "‚úÖ Containers started"
	@echo ""
	@echo "Access the application at: http://localhost:10000"
	@echo "View logs: docker-compose -f docker-compose.traffic-standalone.yml logs -f"

# Stop Docker containers
docker-stop:
	@echo "üê≥ Stopping Docker containers..."
	@docker-compose -f docker-compose.traffic-standalone.yml down
	@echo "‚úÖ Containers stopped"

# Quick setup (install + init-db)
setup: install init-db
	@echo ""
	@echo "‚úÖ Setup complete!"
	@echo ""
	@echo "To start the server, run:"
	@echo "  make run"

# Development setup
dev-setup: setup
	@echo ""
	@echo "To start in development mode, run:"
	@echo "  make run-dev"

# Full test (start server, test, stop)
full-test:
	@echo "üß™ Running full test suite..."
	@PORT=10000 gunicorn --config gunicorn_traffic_config.py traffic_app:app > /dev/null 2>&1 & echo $$! > .server.pid
	@sleep 5
	@python3 test_traffic_health.py http://localhost:10000
	@kill `cat .server.pid` 2>/dev/null || true
	@rm -f .server.pid
	@echo "‚úÖ Full test complete"

# Show logs (if running with systemd or similar)
logs:
	@echo "üìã Recent logs:"
	@tail -n 50 *.log 2>/dev/null || echo "No log files found"

# Monitor (live health checks)
monitor:
	@echo "üìä Monitoring system health (Ctrl+C to stop)..."
	@while true; do \
		clear; \
		echo "========================================"; \
		echo "Traffic System Monitor"; \
		echo "========================================"; \
		echo ""; \
		date; \
		echo ""; \
		curl -s http://localhost:10000/health | python3 -m json.tool 2>/dev/null || echo "‚ùå Server not responding"; \
		echo ""; \
		echo "Press Ctrl+C to stop monitoring"; \
		sleep 5; \
	done
