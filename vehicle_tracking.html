<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تتبع السيارات - نظام إدارة إسكان أعضاء هيئة التدريس</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Tajawal:700,400&display=swap">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    html, body { direction: rtl !important; }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Tajawal', Arial, sans-serif; 
      background: linear-gradient(120deg, #e0e7ef 0%, #f7fcff 100%); 
      min-height: 100vh;
      padding-bottom: 40px;
    }
    
    .header {
      background: linear-gradient(90deg, #0f3d68 60%, #2e8bc0 100%);
      color: #fff;
      padding: 26px 0 20px 0;
      margin-bottom: 36px;
      border-radius: 0 0 32px 32px;
      box-shadow: 0 6px 16px #2e8bc055;
      text-align: center;
      position: relative;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .university-logo {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      object-fit: contain;
      background: white;
      padding: 5px;
    }
    
    .header-text {
      text-align: center;
    }
    
    .header-title { 
      font-size: 2.2em; 
      font-weight: bold; 
      margin: 0; 
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .header-subtitle { 
      margin: 5px 0 0 0; 
      font-size: 1.1em; 
      font-weight: 400; 
      color: #e2eaf3; 
    }
    
    .back-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .user-info {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      backdrop-filter: blur(10px);
    }
    
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .action-bar {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: space-between;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-family: 'Tajawal', Arial, sans-serif;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(90deg, #2e8bc0 0%, #0f3d68 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 139, 192, 0.4);
    }

    .btn-success {
      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .stats-bar {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .stat-item {
      text-align: center;
      padding: 15px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2eaf3 100%);
      border-right: 4px solid #2e8bc0;
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #0f3d68;
      margin-bottom: 5px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      font-size: 1em;
      color: #456;
      font-weight: 500;
    }

    .filter-bar {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-weight: bold;
      color: #0f3d68;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border: 2px solid #e2eaf3;
      border-radius: 8px;
      font-family: 'Tajawal', Arial, sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2e8bc0;
      box-shadow: 0 0 0 3px rgba(46, 139, 192, 0.1);
    }

    .table-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #e2eaf3;
    }

    .data-table th {
      background: linear-gradient(90deg, #0f3d68 60%, #2e8bc0 100%);
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-table tr:hover {
      background: #f8fafc;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .badge-inside {
      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .badge-exited {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .badge-resident {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .badge-visitor {
      background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .badge-delivery {
      background: linear-gradient(90deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #2d3436;
    }

    .badge-staff {
      background: linear-gradient(90deg, #a29bfe 0%, #6c5ce7 100%);
      color: white;
    }

    .badge-other {
      background: linear-gradient(90deg, #dfe6e9 0%, #b2bec3 100%);
      color: #2d3436;
    }

    .action-icons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .action-icon {
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .action-icon:hover {
      transform: scale(1.2);
    }

    .icon-view {
      color: #0984e3;
    }

    .icon-edit {
      color: #fdcb6e;
    }

    .icon-exit {
      color: #00b894;
    }

    .icon-delete {
      color: #d63031;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2eaf3;
    }

    .modal-title {
      font-size: 1.8em;
      font-weight: bold;
      color: #0f3d68;
    }

    .close {
      font-size: 32px;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close:hover {
      color: #d63031;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .camera-section {
      background: linear-gradient(135deg, #f8fafc 0%, #e2eaf3 100%);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    #cameraPreview {
      width: 100%;
      max-width: 500px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }

    #capturedImage {
      width: 100%;
      max-width: 500px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }

    .camera-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .recognition-result {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }

    .recognition-result h4 {
      color: #155724;
      margin-bottom: 10px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e2eaf3;
    }

    .pagination button {
      padding: 8px 15px;
      border: 2px solid #2e8bc0;
      background: white;
      color: #2e8bc0;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Tajawal', Arial, sans-serif;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .pagination button:hover:not(:disabled) {
      background: #2e8bc0;
      color: white;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination span {
      color: #0f3d68;
      font-weight: bold;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 4em;
      margin-bottom: 20px;
      color: #ddd;
    }

    .empty-state h3 {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .header-title {
        font-size: 1.5em;
      }
      
      .action-bar {
        flex-direction: column;
      }

      .action-buttons {
        width: 100%;
        justify-content: center;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }

      .filter-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <img src="university_logo.png" alt="شعار الجامعة" class="university-logo" onerror="this.style.display='none'">
      <div class="header-text">
        <h1 class="header-title">نظام تتبع السيارات الشامل</h1>
        <p class="header-subtitle">تسجيل ومراقبة جميع المركبات الداخلة للإسكان</p>
      </div>
    </div>
    <a href="main_dashboard.html" class="back-btn">
      <i class="fas fa-arrow-right"></i>
      <span>العودة للرئيسية</span>
    </a>
    <div class="user-info" id="userInfo">
      <i class="fas fa-user"></i>
      <span id="userName">مستخدم</span>
    </div>
  </div>

  <div class="main-container">
    <!-- شريط الإجراءات -->
    <div class="action-bar">
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="openAddModal()">
          <i class="fas fa-plus"></i>
          تسجيل دخول سيارة
        </button>
        <button class="btn btn-success" onclick="openCameraModal()">
          <i class="fas fa-camera"></i>
          تسجيل بالكاميرا
        </button>
        <button class="btn btn-secondary" onclick="exportData()">
          <i class="fas fa-file-export"></i>
          تصدير البيانات
        </button>
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
          <i class="fas fa-file-import"></i>
          استيراد البيانات
        </button>
        <input type="file" id="importFile" accept=".csv,.xlsx" style="display: none;" onchange="importData(event)">
      </div>
    </div>

    <!-- شريط الإحصائيات -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="totalVehicles">0</div>
        <div class="stat-label">إجمالي السيارات</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="insideVehicles">0</div>
        <div class="stat-label">السيارات داخل الإسكان</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="todayEntries">0</div>
        <div class="stat-label">دخول اليوم</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="recognizedVehicles">0</div>
        <div class="stat-label">تم التعرف عليها آلياً</div>
      </div>
    </div>

    <!-- شريط الفلاتر -->
    <div class="filter-bar">
      <div class="filter-grid">
        <div class="form-group">
          <label>رقم اللوحة</label>
          <input type="text" id="filterPlate" placeholder="ابحث برقم اللوحة">
        </div>
        <div class="form-group">
          <label>تصنيف السيارة</label>
          <select id="filterCategory">
            <option value="">الكل</option>
            <option value="resident">سكان</option>
            <option value="visitor">زائر</option>
            <option value="delivery">مندوب توصيل</option>
            <option value="staff">موظف</option>
            <option value="contractor">مقاول</option>
            <option value="other">أخرى</option>
          </select>
        </div>
        <div class="form-group">
          <label>الحالة</label>
          <select id="filterStatus">
            <option value="">الكل</option>
            <option value="inside">داخل الإسكان</option>
            <option value="exited">خارج الإسكان</option>
          </select>
        </div>
        <div class="form-group">
          <label>من تاريخ</label>
          <input type="date" id="filterDateFrom">
        </div>
        <div class="form-group">
          <label>إلى تاريخ</label>
          <input type="date" id="filterDateTo">
        </div>
      </div>
      <div style="text-align: center;">
        <button class="btn btn-primary" onclick="applyFilters()">
          <i class="fas fa-search"></i>
          بحث
        </button>
        <button class="btn btn-secondary" onclick="clearFilters()">
          <i class="fas fa-redo"></i>
          إعادة تعيين
        </button>
      </div>
    </div>

    <!-- جدول البيانات -->
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>رقم اللوحة</th>
            <th>التصنيف</th>
            <th>الغرض</th>
            <th>وقت الدخول</th>
            <th>وقت الخروج</th>
            <th>الحالة</th>
            <th>البوابة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="vehicleTableBody">
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <i class="fas fa-car"></i>
                <h3>لا توجد بيانات</h3>
                <p>لم يتم تسجيل أي سيارات بعد</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      
      <div class="pagination" id="paginationContainer" style="display: none;">
        <button id="prevPage" onclick="changePage(-1)">
          <i class="fas fa-chevron-right"></i>
        </button>
        <span>صفحة <span id="currentPage">1</span> من <span id="totalPages">1</span></span>
        <button id="nextPage" onclick="changePage(1)">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- نافذة إضافة/تعديل سيارة -->
  <div id="vehicleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">تسجيل دخول سيارة جديدة</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <form id="vehicleForm">
        <input type="hidden" id="vehicleId">
        
        <div class="form-grid">
          <div class="form-group">
            <label>رقم اللوحة *</label>
            <input type="text" id="plateNumber" required>
          </div>
          
          <div class="form-group">
            <label>نوع المركبة *</label>
            <select id="vehicleType" required>
              <option value="">اختر النوع</option>
              <option value="سيارة">سيارة</option>
              <option value="دراجة نارية">دراجة نارية</option>
              <option value="شاحنة">شاحنة</option>
              <option value="حافلة">حافلة</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>تصنيف السيارة *</label>
            <select id="vehicleCategory" required onchange="updateFormFields()">
              <option value="">اختر التصنيف</option>
              <option value="resident">سكان</option>
              <option value="visitor">زائر</option>
              <option value="delivery">مندوب توصيل</option>
              <option value="staff">موظف</option>
              <option value="contractor">مقاول</option>
              <option value="emergency">طوارئ</option>
              <option value="other">أخرى</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>الغرض من الزيارة *</label>
            <input type="text" id="purpose" required>
          </div>
          
          <div class="form-group" id="visitorNameGroup">
            <label>اسم الزائر/السائق</label>
            <input type="text" id="visitorName">
          </div>
          
          <div class="form-group" id="visitorPhoneGroup">
            <label>رقم الهاتف</label>
            <input type="text" id="visitorPhone">
          </div>
          
          <div class="form-group" id="visitorIdGroup">
            <label>رقم الهوية</label>
            <input type="text" id="visitorIdNumber">
          </div>
          
          <div class="form-group" id="companyNameGroup">
            <label>اسم الشركة</label>
            <input type="text" id="companyName">
          </div>
          
          <div class="form-group">
            <label>الماركة</label>
            <input type="text" id="make">
          </div>
          
          <div class="form-group">
            <label>الموديل</label>
            <input type="text" id="model">
          </div>
          
          <div class="form-group">
            <label>اللون</label>
            <input type="text" id="color">
          </div>
          
          <div class="form-group">
            <label>السنة</label>
            <input type="number" id="year" min="1900" max="2030">
          </div>
          
          <div class="form-group">
            <label>البوابة</label>
            <select id="gateEntry">
              <option value="البوابة الرئيسية">البوابة الرئيسية</option>
              <option value="البوابة الشمالية">البوابة الشمالية</option>
              <option value="البوابة الجنوبية">البوابة الجنوبية</option>
              <option value="البوابة الشرقية">البوابة الشرقية</option>
              <option value="البوابة الغربية">البوابة الغربية</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>ملاحظات</label>
          <textarea id="notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e2eaf3; border-radius: 8px; font-family: 'Tajawal', Arial, sans-serif; resize: vertical;"></textarea>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px;">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            حفظ
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">
            <i class="fas fa-times"></i>
            إلغاء
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- نافذة الكاميرا -->
  <div id="cameraModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">تسجيل سيارة بالكاميرا</h2>
        <span class="close" onclick="closeCameraModal()">&times;</span>
      </div>
      
      <div class="camera-section">
        <h3>التقاط صورة للوحة السيارة</h3>
        <video id="cameraPreview" autoplay></video>
        <img id="capturedImage" alt="Captured Image">
        
        <div class="camera-buttons">
          <button class="btn btn-primary" id="startCameraBtn" onclick="startCamera()">
            <i class="fas fa-video"></i>
            تشغيل الكاميرا
          </button>
          <button class="btn btn-success" id="captureBtn" onclick="captureImage()" style="display: none;">
            <i class="fas fa-camera"></i>
            التقاط الصورة
          </button>
          <button class="btn btn-secondary" id="recognizeBtn" onclick="recognizePlate()" style="display: none;">
            <i class="fas fa-search"></i>
            التعرف على اللوحة
          </button>
          <button class="btn btn-secondary" id="retakeBtn" onclick="retakeImage()" style="display: none;">
            <i class="fas fa-redo"></i>
            إعادة التقاط
          </button>
        </div>
        
        <div class="recognition-result" id="recognitionResult">
          <h4>نتيجة التعرف:</h4>
          <p id="recognizedPlate"></p>
          <button class="btn btn-primary" onclick="useRecognizedPlate()">
            <i class="fas fa-check"></i>
            استخدام هذا الرقم
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 20;
    let allVehicles = [];
    let filteredVehicles = [];
    let currentUser = null;
    let videoStream = null;
    let capturedImageData = null;

    // التحقق من تسجيل الدخول
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/validate', {
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (!data.authenticated) {
          window.location.href = 'index.html';
          return;
        }
        
        currentUser = data.user;
        document.getElementById('userName').textContent = data.user.name || data.user.username;
        
        // تحميل البيانات
        loadVehicles();
        loadStats();
      } catch (error) {
        console.error('Authentication error:', error);
        window.location.href = 'index.html';
      }
    }

    // تحميل بيانات السيارات
    async function loadVehicles() {
      try {
        const response = await fetch('/api/vehicle-tracking/list', {
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
          allVehicles = data.vehicles || [];
          filteredVehicles = allVehicles;
          renderTable();
        } else {
          showAlert('خطأ في تحميل البيانات', 'error');
        }
      } catch (error) {
        console.error('Error loading vehicles:', error);
        showAlert('خطأ في الاتصال بالخادم', 'error');
      }
    }

    // تحميل الإحصائيات
    async function loadStats() {
      try {
        const response = await fetch('/api/vehicle-tracking/stats', {
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('totalVehicles').textContent = data.stats.total || 0;
          document.getElementById('insideVehicles').textContent = data.stats.inside || 0;
          document.getElementById('todayEntries').textContent = data.stats.today || 0;
          document.getElementById('recognizedVehicles').textContent = data.stats.recognized || 0;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // عرض البيانات في الجدول
    function renderTable() {
      const tbody = document.getElementById('vehicleTableBody');
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageVehicles = filteredVehicles.slice(startIndex, endIndex);
      
      if (pageVehicles.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <i class="fas fa-car"></i>
                <h3>لا توجد بيانات</h3>
                <p>لم يتم العثور على نتائج</p>
              </div>
            </td>
          </tr>
        `;
        document.getElementById('paginationContainer').style.display = 'none';
        return;
      }
      
      tbody.innerHTML = pageVehicles.map(vehicle => `
        <tr>
          <td><strong>${vehicle.plate_number}</strong></td>
          <td><span class="badge badge-${vehicle.vehicle_category}">${getCategoryLabel(vehicle.vehicle_category)}</span></td>
          <td>${vehicle.purpose}</td>
          <td>${formatDateTime(vehicle.entry_time)}</td>
          <td>${vehicle.exit_time ? formatDateTime(vehicle.exit_time) : '-'}</td>
          <td><span class="badge badge-${vehicle.status}">${getStatusLabel(vehicle.status)}</span></td>
          <td>${vehicle.gate_entry || '-'}</td>
          <td>
            <div class="action-icons">
              <i class="fas fa-eye icon-view action-icon" onclick="viewVehicle(${vehicle.id})" title="عرض التفاصيل"></i>
              ${vehicle.status === 'inside' ? `<i class="fas fa-sign-out-alt icon-exit action-icon" onclick="exitVehicle(${vehicle.id})" title="تسجيل خروج"></i>` : ''}
              <i class="fas fa-trash icon-delete action-icon" onclick="deleteVehicle(${vehicle.id})" title="حذف"></i>
            </div>
          </td>
        </tr>
      `).join('');
      
      // تحديث Pagination
      totalPages = Math.ceil(filteredVehicles.length / pageSize);
      document.getElementById('currentPage').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
      document.getElementById('paginationContainer').style.display = 'flex';
    }

    // Helper functions
    function getCategoryLabel(category) {
      const labels = {
        'resident': 'سكان',
        'visitor': 'زائر',
        'delivery': 'مندوب',
        'staff': 'موظف',
        'contractor': 'مقاول',
        'emergency': 'طوارئ',
        'other': 'أخرى'
      };
      return labels[category] || category;
    }

    function getStatusLabel(status) {
      return status === 'inside' ? 'داخل الإسكان' : 'خارج الإسكان';
    }

    function formatDateTime(datetime) {
      if (!datetime) return '-';
      const date = new Date(datetime);
      return date.toLocaleString('ar-SA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // فتح نافذة الإضافة
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'تسجيل دخول سيارة جديدة';
      document.getElementById('vehicleForm').reset();
      document.getElementById('vehicleId').value = '';
      document.getElementById('vehicleModal').style.display = 'block';
    }

    // إغلاق النافذة
    function closeModal() {
      document.getElementById('vehicleModal').style.display = 'none';
    }

    // تحديث حقول النموذج بناءً على التصنيف
    function updateFormFields() {
      const category = document.getElementById('vehicleCategory').value;
      
      // إخفاء جميع الحقول الاختيارية
      document.getElementById('visitorNameGroup').style.display = 'block';
      document.getElementById('visitorPhoneGroup').style.display = 'block';
      document.getElementById('visitorIdGroup').style.display = 'block';
      document.getElementById('companyNameGroup').style.display = 'none';
      
      if (category === 'delivery' || category === 'contractor') {
        document.getElementById('companyNameGroup').style.display = 'block';
      }
    }

    // حفظ السيارة
    document.getElementById('vehicleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        plate_number: document.getElementById('plateNumber').value,
        vehicle_type: document.getElementById('vehicleType').value,
        vehicle_category: document.getElementById('vehicleCategory').value,
        purpose: document.getElementById('purpose').value,
        visitor_name: document.getElementById('visitorName').value,
        visitor_phone: document.getElementById('visitorPhone').value,
        visitor_id_number: document.getElementById('visitorIdNumber').value,
        company_name: document.getElementById('companyName').value,
        make: document.getElementById('make').value,
        model: document.getElementById('model').value,
        color: document.getElementById('color').value,
        year: document.getElementById('year').value,
        gate_entry: document.getElementById('gateEntry').value,
        notes: document.getElementById('notes').value
      };
      
      try {
        const response = await fetch('/api/vehicle-tracking/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('تم تسجيل دخول السيارة بنجاح', 'success');
          closeModal();
          loadVehicles();
          loadStats();
        } else {
          showAlert(data.error_ar || data.error, 'error');
        }
      } catch (error) {
        console.error('Error saving vehicle:', error);
        showAlert('خطأ في حفظ البيانات', 'error');
      }
    });

    // تسجيل خروج سيارة
    async function exitVehicle(id) {
      if (!confirm('هل تريد تسجيل خروج هذه السيارة؟')) return;
      
      try {
        const response = await fetch(`/api/vehicle-tracking/exit/${id}`, {
          method: 'POST',
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('تم تسجيل خروج السيارة بنجاح', 'success');
          loadVehicles();
          loadStats();
        } else {
          showAlert(data.error_ar || data.error, 'error');
        }
      } catch (error) {
        console.error('Error exiting vehicle:', error);
        showAlert('خطأ في تسجيل الخروج', 'error');
      }
    }

    // حذف سيارة
    async function deleteVehicle(id) {
      if (!confirm('هل تريد حذف هذا السجل؟')) return;
      
      try {
        const response = await fetch(`/api/vehicle-tracking/delete/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('تم حذف السجل بنجاح', 'success');
          loadVehicles();
          loadStats();
        } else {
          showAlert(data.error_ar || data.error, 'error');
        }
      } catch (error) {
        console.error('Error deleting vehicle:', error);
        showAlert('خطأ في حذف السجل', 'error');
      }
    }

    // عرض تفاصيل السيارة
    function viewVehicle(id) {
      const vehicle = allVehicles.find(v => v.id === id);
      if (!vehicle) return;
      
      alert(`تفاصيل السيارة:\n\nرقم اللوحة: ${vehicle.plate_number}\nالتصنيف: ${getCategoryLabel(vehicle.vehicle_category)}\nالغرض: ${vehicle.purpose}\nوقت الدخول: ${formatDateTime(vehicle.entry_time)}\n${vehicle.exit_time ? 'وقت الخروج: ' + formatDateTime(vehicle.exit_time) : ''}`);
    }

    // تطبيق الفلاتر
    function applyFilters() {
      const plate = document.getElementById('filterPlate').value.toLowerCase();
      const category = document.getElementById('filterCategory').value;
      const status = document.getElementById('filterStatus').value;
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;
      
      filteredVehicles = allVehicles.filter(vehicle => {
        if (plate && !vehicle.plate_number.toLowerCase().includes(plate)) return false;
        if (category && vehicle.vehicle_category !== category) return false;
        if (status && vehicle.status !== status) return false;
        if (dateFrom && new Date(vehicle.entry_time) < new Date(dateFrom)) return false;
        if (dateTo && new Date(vehicle.entry_time) > new Date(dateTo + 'T23:59:59')) return false;
        return true;
      });
      
      currentPage = 1;
      renderTable();
    }

    // إعادة تعيين الفلاتر
    function clearFilters() {
      document.getElementById('filterPlate').value = '';
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      filteredVehicles = allVehicles;
      currentPage = 1;
      renderTable();
    }

    // تغيير الصفحة
    function changePage(direction) {
      currentPage += direction;
      renderTable();
    }

    // فتح نافذة الكاميرا
    function openCameraModal() {
      document.getElementById('cameraModal').style.display = 'block';
    }

    // إغلاق نافذة الكاميرا
    function closeCameraModal() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      document.getElementById('cameraModal').style.display = 'none';
      document.getElementById('cameraPreview').style.display = 'none';
      document.getElementById('capturedImage').style.display = 'none';
      document.getElementById('recognitionResult').style.display = 'none';
    }

    // تشغيل الكاميرا
    async function startCamera() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        const video = document.getElementById('cameraPreview');
        video.srcObject = videoStream;
        video.style.display = 'block';
        document.getElementById('startCameraBtn').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'inline-block';
      } catch (error) {
        console.error('Error accessing camera:', error);
        showAlert('خطأ في الوصول للكاميرا', 'error');
      }
    }

    // التقاط صورة
    function captureImage() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      capturedImageData = canvas.toDataURL('image/jpeg');
      document.getElementById('capturedImage').src = capturedImageData;
      document.getElementById('capturedImage').style.display = 'block';
      document.getElementById('cameraPreview').style.display = 'none';
      document.getElementById('captureBtn').style.display = 'none';
      document.getElementById('recognizeBtn').style.display = 'inline-block';
      document.getElementById('retakeBtn').style.display = 'inline-block';
    }

    // إعادة التقاط
    function retakeImage() {
      document.getElementById('capturedImage').style.display = 'none';
      document.getElementById('cameraPreview').style.display = 'block';
      document.getElementById('captureBtn').style.display = 'inline-block';
      document.getElementById('recognizeBtn').style.display = 'none';
      document.getElementById('retakeBtn').style.display = 'none';
      document.getElementById('recognitionResult').style.display = 'none';
    }

    // التعرف على اللوحة
    async function recognizePlate() {
      try {
        document.getElementById('recognizeBtn').disabled = true;
        document.getElementById('recognizeBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التعرف...';
        
        const response = await fetch('/api/plate-recognizer/recognize', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            base64_image: capturedImageData,
            regions: ['sa']
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.results && data.results.length > 0) {
          const result = data.results[0];
          document.getElementById('recognizedPlate').textContent = `رقم اللوحة: ${result.plate} (الثقة: ${(result.confidence * 100).toFixed(1)}%)`;
          document.getElementById('recognitionResult').style.display = 'block';
        } else {
          showAlert('لم يتم التعرف على اللوحة. يرجى المحاولة مرة أخرى.', 'error');
        }
      } catch (error) {
        console.error('Error recognizing plate:', error);
        showAlert('خطأ في التعرف على اللوحة', 'error');
      } finally {
        document.getElementById('recognizeBtn').disabled = false;
        document.getElementById('recognizeBtn').innerHTML = '<i class="fas fa-search"></i> التعرف على اللوحة';
      }
    }

    // استخدام الرقم المعرّف
    function useRecognizedPlate() {
      const plateText = document.getElementById('recognizedPlate').textContent;
      const plateNumber = plateText.match(/رقم اللوحة: (.*?) \(/)[1];
      closeCameraModal();
      openAddModal();
      document.getElementById('plateNumber').value = plateNumber;
    }

    // تصدير البيانات
    async function exportData() {
      try {
        const response = await fetch('/api/vehicle-tracking/export', {
          credentials: 'include'
        });
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vehicle_tracking_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showAlert('تم تصدير البيانات بنجاح', 'success');
      } catch (error) {
        console.error('Error exporting data:', error);
        showAlert('خطأ في تصدير البيانات', 'error');
      }
    }

    // استيراد البيانات
    async function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const response = await fetch('/api/vehicle-tracking/import', {
          method: 'POST',
          credentials: 'include',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert(`تم استيراد ${data.imported} سجل بنجاح`, 'success');
          loadVehicles();
          loadStats();
        } else {
          showAlert(data.error_ar || data.error, 'error');
        }
      } catch (error) {
        console.error('Error importing data:', error);
        showAlert('خطأ في استيراد البيانات', 'error');
      }
      
      event.target.value = '';
    }

    // عرض رسالة تنبيه
    function showAlert(message, type) {
      alert(message);
    }

    // إغلاق النافذة عند الضغط خارجها
    window.onclick = function(event) {
      const vehicleModal = document.getElementById('vehicleModal');
      const cameraModal = document.getElementById('cameraModal');
      if (event.target == vehicleModal) {
        closeModal();
      }
      if (event.target == cameraModal) {
        closeCameraModal();
      }
    }

    // تشغيل عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>
