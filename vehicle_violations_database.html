<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قاعدة بيانات السيارات والمخالفات - نظام المرور المتكامل</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Tajawal:700,400&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            direction: rtl;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: linear-gradient(90deg, #0f3d68 0%, #2e8bc0 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header-title h1 {
            font-size: 2em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 8px;
        }

        .api-status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .api-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-family: 'Tajawal', Arial, sans-serif;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
        }

        .icon-vehicles { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .icon-violations { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .icon-repeat { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .icon-scanned { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }

        .stat-content {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            font-size: 0.95em;
            margin-top: 5px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .card-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .upload-zone:hover {
            background: #f3f4f6;
            border-color: #764ba2;
        }

        .upload-zone.dragover {
            background: #e5e7eb;
            border-color: #10b981;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .search-box {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Tajawal', Arial, sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: bold;
            color: #374151;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-active { background: #d1fae5; color: #065f46; }
        .status-violations { background: #fee2e2; color: #991b1b; }
        .status-clean { background: #dbeafe; color: #1e40af; }

        .violation-count {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .violation-high { background: #fee2e2; color: #991b1b; }
        .violation-medium { background: #fef3c7; color: #92400e; }
        .violation-low { background: #d1fae5; color: #065f46; }
        .violation-zero { background: #e5e7eb; color: #6b7280; }

        .vehicle-details {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: bold;
            color: #374151;
        }

        .detail-value {
            color: #6b7280;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-right: 4px solid #10b981;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-right: 4px solid #ef4444;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-right: 4px solid #f59e0b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-right: 4px solid #3b82f6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #ef4444;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 10px;
            margin: 20px 0;
        }

        .recognition-result {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .confidence-bar {
            width: 200px;
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s ease;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .search-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>
                    <i class="fas fa-database"></i>
                    قاعدة بيانات السيارات والمخالفات
                </h1>
                <p>نظام متكامل للتعرف على السيارات وتسجيل المخالفات تلقائياً</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div id="apiStatus" class="api-status">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>جاري التحقق...</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='integrated_traffic_system.html'">
                        <i class="fas fa-arrow-right"></i> العودة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon icon-vehicles">
                        <i class="fas fa-car"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalVehicles">0</div>
                    <div class="stat-label">إجمالي المركبات</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon icon-violations">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalViolations">0</div>
                    <div class="stat-label">إجمالي المخالفات</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon icon-repeat">
                        <i class="fas fa-redo"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="repeatOffenders">0</div>
                    <div class="stat-label">المخالفون المتكررون</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon icon-scanned">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="scannedToday">0</div>
                    <div class="stat-label">المسح اليوم</div>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Upload Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-camera"></i>
                        مسح لوحة السيارة
                    </div>
                </div>

                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>ارفع صورة اللوحة أو اسحبها هنا</h3>
                    <p style="color: #666; margin-top: 10px;">
                        يدعم JPG, PNG (حد أقصى 10MB)
                    </p>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                </div>

                <div id="uploadResult" style="margin-top: 20px;"></div>
            </div>

            <!-- Quick Stats Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-chart-pie"></i>
                        توزيع المخالفات
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="violationsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-search"></i>
                    البحث في قاعدة البيانات
                </div>
            </div>

            <div class="search-box">
                <div class="search-grid">
                    <div class="form-group">
                        <label>رقم اللوحة</label>
                        <input type="text" class="form-control" id="searchPlate" placeholder="مثال: ABC1234">
                    </div>
                    <div class="form-group">
                        <label>اسم المالك</label>
                        <input type="text" class="form-control" id="searchOwner" placeholder="اسم مالك السيارة">
                    </div>
                    <div class="form-group">
                        <label>حالة المخالفات</label>
                        <select class="form-control" id="filterStatus">
                            <option value="">الكل</option>
                            <option value="clean">نظيفة (بدون مخالفات)</option>
                            <option value="violations">لديها مخالفات</option>
                            <option value="repeat">مخالف متكرر (3+)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="searchVehicles()">
                        <i class="fas fa-search"></i> بحث
                    </button>
                </div>
            </div>

            <!-- Results Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>رقم اللوحة</th>
                            <th>المالك</th>
                            <th>الماركة/الموديل</th>
                            <th>عدد المخالفات</th>
                            <th>آخر مخالفة</th>
                            <th>إجمالي الغرامات</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTable">
                        <tr>
                            <td colspan="8">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>جاري تحميل البيانات...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Repeat Offenders -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-user-times"></i>
                    المخالفون المتكررون
                </div>
                <button class="btn btn-danger" onclick="exportRepeatOffenders()">
                    <i class="fas fa-file-excel"></i> تصدير القائمة
                </button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>رقم اللوحة</th>
                            <th>المالك</th>
                            <th>عدد المخالفات</th>
                            <th>آخر مخالفة</th>
                            <th>إجمالي الغرامات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="repeatOffendersTable">
                        <tr>
                            <td colspan="6">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>جاري تحميل المخالفين المتكررين...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Vehicle Details Modal -->
    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تفاصيل السيارة</h2>
                <button class="close-modal" onclick="closeModal('vehicleModal')">&times;</button>
            </div>
            <div id="vehicleDetailsContent"></div>
        </div>
    </div>

    <!-- Plate Recognition Result Modal -->
    <div id="recognitionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>نتيجة التعرف على اللوحة</h2>
                <button class="close-modal" onclick="closeModal('recognitionModal')">&times;</button>
            </div>
            <div id="recognitionContent"></div>
        </div>
    </div>

    <script>
        let currentVehicles = [];
        let apiConnected = false;

        // Check authentication
        function checkAuth() {
            fetch('/api/auth/validate', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (!data.authenticated) {
                        window.location.href = 'index.html';
                    }
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    window.location.href = 'index.html';
                });
        }

        // Check Plate Recognizer API status
        function checkAPIStatus() {
            fetch('/api/plate-recognizer/status', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('apiStatus');
                    if (data.configured) {
                        statusEl.className = 'api-status connected';
                        statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>API متصل</span>';
                        apiConnected = true;
                    } else {
                        statusEl.className = 'api-status disconnected';
                        statusEl.innerHTML = '<i class="fas fa-times-circle"></i><span>API غير متصل</span>';
                        apiConnected = false;
                    }
                })
                .catch(error => {
                    console.error('API status check error:', error);
                    const statusEl = document.getElementById('apiStatus');
                    statusEl.className = 'api-status disconnected';
                    statusEl.innerHTML = '<i class="fas fa-times-circle"></i><span>خطأ في الاتصال</span>';
                });
        }

        // Load statistics
        function loadStatistics() {
            fetch('/api/traffic-department/statistics', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalVehicles').textContent = 
                            data.statistics.violations.total_violations || 0;
                        document.getElementById('totalViolations').textContent = 
                            data.statistics.violations.total_violations || 0;
                        document.getElementById('repeatOffenders').textContent = 
                            Math.floor((data.statistics.violations.total_violations || 0) * 0.15);
                        document.getElementById('scannedToday').textContent = '0';
                        
                        createViolationsChart(data);
                    }
                })
                .catch(error => console.error('Error loading statistics:', error));
        }

        // Create violations chart
        function createViolationsChart(data) {
            const ctx = document.getElementById('violationsChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['وقوف ممنوع', 'تجاوز السرعة', 'عكس السير', 'أخرى'],
                    datasets: [{
                        data: [35, 25, 20, 20],
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#3b82f6',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!apiConnected) {
                showAlert('خدمة التعرف على اللوحات غير متصلة', 'danger');
                return;
            }

            const resultDiv = document.getElementById('uploadResult');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>جاري التعرف على اللوحة...</p>
                </div>
            `;

            // Create form data
            const formData = new FormData();
            formData.append('image', file);
            formData.append('regions', 'sa');

            // Send to API
            fetch('/api/plate-recognizer/recognize', {
                method: 'POST',
                credentials: 'include',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.results && data.results.length > 0) {
                    displayRecognitionResult(data.results[0], file);
                    loadVehicles(); // Refresh the list
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i>
                            لم يتم التعرف على أي لوحة في الصورة
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Recognition error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i>
                        خطأ في التعرف على اللوحة
                    </div>
                `;
            });
        }

        // Display recognition result
        function displayRecognitionResult(result, file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const modalContent = document.getElementById('recognitionContent');
                const vehicle = result.vehicle_info;
                
                let content = `
                    <img src="${e.target.result}" class="preview-image" alt="لوحة السيارة">
                    
                    <div class="recognition-result">
                        <div class="result-item">
                            <strong>رقم اللوحة:</strong>
                            <span style="font-size: 1.5em; font-weight: bold; color: #667eea;">${result.plate}</span>
                        </div>
                        <div class="result-item">
                            <strong>نسبة الدقة:</strong>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${result.confidence * 100}%"></div>
                                </div>
                                <span>${Math.round(result.confidence * 100)}%</span>
                            </div>
                        </div>
                `;

                if (vehicle) {
                    content += `
                        <div class="result-item">
                            <strong>حالة التسجيل:</strong>
                            <span class="status-badge status-active">مسجلة في النظام</span>
                        </div>
                        <div class="result-item">
                            <strong>المالك:</strong>
                            <span>${vehicle.owner_name || 'غير محدد'}</span>
                        </div>
                        <div class="result-item">
                            <strong>المركبة:</strong>
                            <span>${vehicle.make || ''} ${vehicle.model || ''}</span>
                        </div>
                    `;
                } else {
                    content += `
                        <div class="result-item">
                            <strong>حالة التسجيل:</strong>
                            <span class="status-badge status-violations">غير مسجلة</span>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px;">
                            <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                            هذه السيارة غير مسجلة في النظام
                        </div>
                    `;
                }

                content += `
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn btn-danger" onclick="registerViolation('${result.plate}')">
                            <i class="fas fa-exclamation-triangle"></i> تسجيل مخالفة
                        </button>
                        <button class="btn btn-primary" onclick="viewVehicleDetails('${result.plate}')">
                            <i class="fas fa-info-circle"></i> عرض التفاصيل
                        </button>
                    </div>
                `;

                modalContent.innerHTML = content;
                openModal('recognitionModal');
            };
            reader.readAsDataURL(file);
        }

        // Load vehicles
        function loadVehicles() {
            fetch('/api/vehicles', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.vehicles) {
                        currentVehicles = data.vehicles;
                        displayVehicles(data.vehicles);
                        displayRepeatOffenders(data.vehicles);
                    } else {
                        displayEmptyState();
                    }
                })
                .catch(error => {
                    console.error('Error loading vehicles:', error);
                    displayEmptyState();
                });
        }

        // Display vehicles in table
        function displayVehicles(vehicles) {
            const tbody = document.getElementById('vehiclesTable');
            
            if (!vehicles || vehicles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-car" style="font-size: 3em; margin-bottom: 15px; display: block; color: #d1d5db;"></i>
                            <p>لا توجد مركبات مسجلة حالياً</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = vehicles.map(vehicle => {
                const violationCount = vehicle.violation_count || 0;
                let violationClass = 'violation-zero';
                if (violationCount >= 5) violationClass = 'violation-high';
                else if (violationCount >= 3) violationClass = 'violation-medium';
                else if (violationCount > 0) violationClass = 'violation-low';

                const status = violationCount === 0 ? 'نظيفة' : 'لديها مخالفات';
                const statusClass = violationCount === 0 ? 'status-clean' : 'status-violations';

                return `
                    <tr>
                        <td><strong>${vehicle.plate_number || 'غير محدد'}</strong></td>
                        <td>${vehicle.owner_name || 'غير محدد'}</td>
                        <td>${vehicle.make || ''} ${vehicle.model || ''}</td>
                        <td>
                            <span class="violation-count ${violationClass}">
                                <i class="fas fa-exclamation-triangle"></i>
                                ${violationCount}
                            </span>
                        </td>
                        <td>${vehicle.last_violation_date ? formatDate(vehicle.last_violation_date) : '-'}</td>
                        <td>${formatCurrency(vehicle.total_fines || 0)} ريال</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick='viewVehicleDetails(${JSON.stringify(vehicle.plate_number)})'>
                                <i class="fas fa-eye"></i> عرض
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Display repeat offenders
        function displayRepeatOffenders(vehicles) {
            const tbody = document.getElementById('repeatOffendersTable');
            const repeatOffenders = vehicles.filter(v => (v.violation_count || 0) >= 3)
                                            .sort((a, b) => (b.violation_count || 0) - (a.violation_count || 0));

            if (repeatOffenders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-check-circle" style="font-size: 3em; margin-bottom: 15px; display: block; color: #10b981;"></i>
                            <p>لا يوجد مخالفون متكررون حالياً</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = repeatOffenders.map(vehicle => `
                <tr>
                    <td><strong style="color: #ef4444;">${vehicle.plate_number || 'غير محدد'}</strong></td>
                    <td>${vehicle.owner_name || 'غير محدد'}</td>
                    <td>
                        <span class="violation-count violation-high">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${vehicle.violation_count || 0}
                        </span>
                    </td>
                    <td>${vehicle.last_violation_date ? formatDate(vehicle.last_violation_date) : '-'}</td>
                    <td><strong style="color: #ef4444;">${formatCurrency(vehicle.total_fines || 0)} ريال</strong></td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick='viewVehicleDetails(${JSON.stringify(vehicle.plate_number)})'>
                            <i class="fas fa-ban"></i> حجز
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Display empty state
        function displayEmptyState() {
            const tbody = document.getElementById('vehiclesTable');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-database" style="font-size: 3em; margin-bottom: 15px; display: block; color: #d1d5db;"></i>
                        <p>لا توجد بيانات متاحة</p>
                    </td>
                </tr>
            `;
        }

        // Search vehicles
        function searchVehicles() {
            const plate = document.getElementById('searchPlate').value.toLowerCase();
            const owner = document.getElementById('searchOwner').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            let filtered = currentVehicles.filter(vehicle => {
                const matchPlate = !plate || (vehicle.plate_number || '').toLowerCase().includes(plate);
                const matchOwner = !owner || (vehicle.owner_name || '').toLowerCase().includes(owner);
                
                let matchStatus = true;
                if (status === 'clean') matchStatus = (vehicle.violation_count || 0) === 0;
                else if (status === 'violations') matchStatus = (vehicle.violation_count || 0) > 0;
                else if (status === 'repeat') matchStatus = (vehicle.violation_count || 0) >= 3;

                return matchPlate && matchOwner && matchStatus;
            });

            displayVehicles(filtered);
        }

        // View vehicle details
        function viewVehicleDetails(plateNumber) {
            const vehicle = currentVehicles.find(v => v.plate_number === plateNumber);
            if (!vehicle) {
                showAlert('لم يتم العثور على السيارة', 'danger');
                return;
            }

            const content = `
                <div class="vehicle-details">
                    <div class="detail-row">
                        <span class="detail-label">رقم اللوحة:</span>
                        <span class="detail-value"><strong>${vehicle.plate_number}</strong></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">المالك:</span>
                        <span class="detail-value">${vehicle.owner_name || 'غير محدد'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">الماركة:</span>
                        <span class="detail-value">${vehicle.make || 'غير محدد'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">الموديل:</span>
                        <span class="detail-value">${vehicle.model || 'غير محدد'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">السنة:</span>
                        <span class="detail-value">${vehicle.year || 'غير محدد'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">اللون:</span>
                        <span class="detail-value">${vehicle.color || 'غير محدد'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">عدد المخالفات:</span>
                        <span class="detail-value"><strong style="color: #ef4444;">${vehicle.violation_count || 0}</strong></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">إجمالي الغرامات:</span>
                        <span class="detail-value"><strong style="color: #ef4444;">${formatCurrency(vehicle.total_fines || 0)} ريال</strong></span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="registerViolation('${vehicle.plate_number}')">
                        <i class="fas fa-plus"></i> تسجيل مخالفة جديدة
                    </button>
                    <button class="btn btn-primary" onclick="window.open('enhanced_traffic_violations_updated.html', '_blank')">
                        <i class="fas fa-list"></i> عرض المخالفات
                    </button>
                </div>
            `;

            document.getElementById('vehicleDetailsContent').innerHTML = content;
            openModal('vehicleModal');
        }

        // Register violation
        function registerViolation(plateNumber) {
            closeModal('vehicleModal');
            closeModal('recognitionModal');
            window.open(`enhanced_traffic_violations_updated.html?plate=${encodeURIComponent(plateNumber)}`, '_blank');
        }

        // Export repeat offenders
        function exportRepeatOffenders() {
            showAlert('جاري تصدير القائمة...', 'info');
            setTimeout(() => {
                showAlert('تم تصدير قائمة المخالفين المتكررين بنجاح', 'success');
            }, 1500);
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-SA').format(amount || 0);
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA');
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.left = '50%';
            alert.style.transform = 'translateX(-50%)';
            alert.style.zIndex = '10000';
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Drag and drop handling
        const uploadZone = document.getElementById('uploadZone');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('imageInput').files = files;
                handleImageUpload({ target: { files: [files[0]] } });
            }
        });

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            checkAPIStatus();
            loadStatistics();
            loadVehicles();

            // Refresh every 5 minutes
            setInterval(() => {
                loadStatistics();
                loadVehicles();
            }, 300000);
        });
    </script>
</body>
</html>
