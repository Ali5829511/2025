<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة الاستعلام الشامل - نظام المرور المتكامل</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Tajawal:700,400&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            direction: rtl;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: linear-gradient(90deg, #0f3d68 0%, #2e8bc0 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header-title h1 {
            font-size: 2em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-family: 'Tajawal', Arial, sans-serif;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .search-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.05em;
            font-family: 'Tajawal', Arial, sans-serif;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-form {
            background: #f9fafb;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Tajawal', Arial, sans-serif;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            color: #666;
            font-size: 0.95em;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: bold;
            color: #374151;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-active { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-resolved { background: #dbeafe; color: #1e40af; }
        .status-critical { background: #fee2e2; color: #991b1b; }

        .info-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border-right: 4px solid #667eea;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
        }

        .info-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-right: 4px solid #3b82f6;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-right: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-right: 4px solid #f59e0b;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-right: 4px solid #ef4444;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            color: #d1d5db;
            margin-bottom: 20px;
        }

        .export-options {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .search-tabs {
                flex-wrap: wrap;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .search-actions {
                flex-direction: column;
            }

            .export-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>
                    <i class="fas fa-search"></i>
                    صفحة الاستعلام الشامل
                </h1>
                <p>الاستعلام عن المركبات، المخالفات، الحوادث والسيارات المحجوزة</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='integrated_traffic_system.html'">
                    <i class="fas fa-arrow-right"></i> العودة
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='main_dashboard.html'">
                    <i class="fas fa-home"></i> الرئيسية
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-header">
                <div class="search-title">
                    <i class="fas fa-filter"></i>
                    خيارات البحث والاستعلام
                </div>
            </div>

            <!-- Search Tabs -->
            <div class="search-tabs">
                <button class="tab-btn active" onclick="switchTab('vehicles')">
                    <i class="fas fa-car"></i> المركبات
                </button>
                <button class="tab-btn" onclick="switchTab('violations')">
                    <i class="fas fa-exclamation-triangle"></i> المخالفات
                </button>
                <button class="tab-btn" onclick="switchTab('accidents')">
                    <i class="fas fa-car-crash"></i> الحوادث
                </button>
                <button class="tab-btn" onclick="switchTab('immobilized')">
                    <i class="fas fa-ban"></i> السيارات المحجوزة
                </button>
            </div>

            <!-- Vehicles Search -->
            <div id="vehicles" class="tab-content active">
                <div class="search-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>رقم اللوحة</label>
                            <input type="text" class="form-control" id="vehiclePlate" placeholder="ABC1234">
                        </div>
                        <div class="form-group">
                            <label>اسم المالك</label>
                            <input type="text" class="form-control" id="vehicleOwner" placeholder="اسم مالك المركبة">
                        </div>
                        <div class="form-group">
                            <label>الماركة</label>
                            <input type="text" class="form-control" id="vehicleMake" placeholder="تويوتا، هوندا...">
                        </div>
                        <div class="form-group">
                            <label>الموديل</label>
                            <input type="text" class="form-control" id="vehicleModel" placeholder="كامري، أكورد...">
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-secondary" onclick="clearVehicleSearch()">
                            <i class="fas fa-times"></i> مسح
                        </button>
                        <button class="btn btn-primary" onclick="searchVehicles()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                </div>
            </div>

            <!-- Violations Search -->
            <div id="violations" class="tab-content">
                <div class="search-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>رقم اللوحة</label>
                            <input type="text" class="form-control" id="violationPlate" placeholder="ABC1234">
                        </div>
                        <div class="form-group">
                            <label>نوع المخالفة</label>
                            <select class="form-control" id="violationType">
                                <option value="">جميع الأنواع</option>
                                <option value="وقوف في مكان ممنوع">وقوف في مكان ممنوع</option>
                                <option value="تجاوز السرعة المحددة">تجاوز السرعة</option>
                                <option value="عدم الالتزام بإشارة المرور">عدم الالتزام بإشارة المرور</option>
                                <option value="استخدام الهاتف أثناء القيادة">استخدام الهاتف</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>من تاريخ</label>
                            <input type="date" class="form-control" id="violationFromDate">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ</label>
                            <input type="date" class="form-control" id="violationToDate">
                        </div>
                        <div class="form-group">
                            <label>الحالة</label>
                            <select class="form-control" id="violationStatus">
                                <option value="">جميع الحالات</option>
                                <option value="pending">معلقة</option>
                                <option value="resolved">محلولة</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-secondary" onclick="clearViolationSearch()">
                            <i class="fas fa-times"></i> مسح
                        </button>
                        <button class="btn btn-primary" onclick="searchViolations()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                </div>
            </div>

            <!-- Accidents Search -->
            <div id="accidents" class="tab-content">
                <div class="search-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>رقم الحادث</label>
                            <input type="text" class="form-control" id="accidentNumber" placeholder="ACC-2025-00001">
                        </div>
                        <div class="form-group">
                            <label>الموقع</label>
                            <input type="text" class="form-control" id="accidentLocation" placeholder="موقع الحادث">
                        </div>
                        <div class="form-group">
                            <label>من تاريخ</label>
                            <input type="date" class="form-control" id="accidentFromDate">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ</label>
                            <input type="date" class="form-control" id="accidentToDate">
                        </div>
                        <div class="form-group">
                            <label>درجة الخطورة</label>
                            <select class="form-control" id="accidentSeverity">
                                <option value="">جميع الدرجات</option>
                                <option value="minor">بسيط</option>
                                <option value="moderate">متوسط</option>
                                <option value="severe">خطير</option>
                                <option value="critical">حرج</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-secondary" onclick="clearAccidentSearch()">
                            <i class="fas fa-times"></i> مسح
                        </button>
                        <button class="btn btn-primary" onclick="searchAccidents()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                </div>
            </div>

            <!-- Immobilized Cars Search -->
            <div id="immobilized" class="tab-content">
                <div class="search-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>رقم اللوحة</label>
                            <input type="text" class="form-control" id="immobilizedPlate" placeholder="ABC1234">
                        </div>
                        <div class="form-group">
                            <label>من تاريخ الحجز</label>
                            <input type="date" class="form-control" id="immobilizedFromDate">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ الحجز</label>
                            <input type="date" class="form-control" id="immobilizedToDate">
                        </div>
                        <div class="form-group">
                            <label>حالة الدفع</label>
                            <select class="form-control" id="paymentStatus">
                                <option value="">جميع الحالات</option>
                                <option value="unpaid">غير مدفوعة</option>
                                <option value="paid">مدفوعة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الحالة</label>
                            <select class="form-control" id="immobilizedStatus">
                                <option value="">جميع الحالات</option>
                                <option value="immobilized">محجوزة</option>
                                <option value="released">مفرج عنها</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-secondary" onclick="clearImmobilizedSearch()">
                            <i class="fas fa-times"></i> مسح
                        </button>
                        <button class="btn btn-primary" onclick="searchImmobilized()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <div>
                    <h2 style="color: #333; margin-bottom: 5px;">نتائج البحث</h2>
                    <p class="results-count" id="resultsCount">ابدأ البحث لعرض النتائج</p>
                </div>
                <div class="export-options">
                    <button class="btn btn-success btn-small" onclick="exportResults('excel')">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-primary btn-small" onclick="exportResults('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="window.print()">
                        <i class="fas fa-print"></i> طباعة
                    </button>
                </div>
            </div>

            <div id="resultsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>ابدأ البحث للاستعلام عن البيانات</h3>
                    <p>استخدم الخيارات أعلاه للبحث في قاعدة البيانات</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        function checkAuth() {
            fetch('/api/auth/validate', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (!data.authenticated) {
                        window.location.href = 'index.html';
                    }
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    window.location.href = 'index.html';
                });
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Clear results
            clearResults();
        }

        // Clear functions
        function clearVehicleSearch() {
            document.getElementById('vehiclePlate').value = '';
            document.getElementById('vehicleOwner').value = '';
            document.getElementById('vehicleMake').value = '';
            document.getElementById('vehicleModel').value = '';
        }

        function clearViolationSearch() {
            document.getElementById('violationPlate').value = '';
            document.getElementById('violationType').value = '';
            document.getElementById('violationFromDate').value = '';
            document.getElementById('violationToDate').value = '';
            document.getElementById('violationStatus').value = '';
        }

        function clearAccidentSearch() {
            document.getElementById('accidentNumber').value = '';
            document.getElementById('accidentLocation').value = '';
            document.getElementById('accidentFromDate').value = '';
            document.getElementById('accidentToDate').value = '';
            document.getElementById('accidentSeverity').value = '';
        }

        function clearImmobilizedSearch() {
            document.getElementById('immobilizedPlate').value = '';
            document.getElementById('immobilizedFromDate').value = '';
            document.getElementById('immobilizedToDate').value = '';
            document.getElementById('paymentStatus').value = '';
            document.getElementById('immobilizedStatus').value = '';
        }

        function clearResults() {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>ابدأ البحث للاستعلام عن البيانات</h3>
                    <p>استخدم الخيارات أعلاه للبحث في قاعدة البيانات</p>
                </div>
            `;
            document.getElementById('resultsCount').textContent = 'ابدأ البحث لعرض النتائج';
        }

        // Search functions
        function searchVehicles() {
            showLoading();
            
            fetch('/api/vehicles', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.vehicles) {
                        const plate = document.getElementById('vehiclePlate').value.toLowerCase();
                        const owner = document.getElementById('vehicleOwner').value.toLowerCase();
                        const make = document.getElementById('vehicleMake').value.toLowerCase();
                        const model = document.getElementById('vehicleModel').value.toLowerCase();

                        let filtered = data.vehicles.filter(vehicle => {
                            const matchPlate = !plate || (vehicle.plate_number || '').toLowerCase().includes(plate);
                            const matchOwner = !owner || (vehicle.owner_name || '').toLowerCase().includes(owner);
                            const matchMake = !make || (vehicle.make || '').toLowerCase().includes(make);
                            const matchModel = !model || (vehicle.model || '').toLowerCase().includes(model);
                            return matchPlate && matchOwner && matchMake && matchModel;
                        });

                        displayVehiclesResults(filtered);
                    } else {
                        showError('فشل في جلب بيانات المركبات');
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showError('حدث خطأ في البحث');
                });
        }

        function searchViolations() {
            showLoading();
            
            const params = new URLSearchParams();
            const plate = document.getElementById('violationPlate').value;
            const fromDate = document.getElementById('violationFromDate').value;
            const toDate = document.getElementById('violationToDate').value;
            const status = document.getElementById('violationStatus').value;
            
            if (fromDate) params.append('from_date', fromDate);
            if (toDate) params.append('to_date', toDate);
            if (status) params.append('status', status);
            
            fetch(`/api/traffic-accidents?${params}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    // Implement violations display
                    showInfo('جاري تطوير عرض المخالفات...');
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showError('حدث خطأ في البحث');
                });
        }

        function searchAccidents() {
            showLoading();
            
            const params = new URLSearchParams();
            const fromDate = document.getElementById('accidentFromDate').value;
            const toDate = document.getElementById('accidentToDate').value;
            const severity = document.getElementById('accidentSeverity').value;
            
            if (fromDate) params.append('from_date', fromDate);
            if (toDate) params.append('to_date', toDate);
            if (severity) params.append('severity', severity);
            
            fetch(`/api/traffic-accidents?${params}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.accidents) {
                        displayAccidentsResults(data.accidents);
                    } else {
                        showError('فشل في جلب بيانات الحوادث');
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showError('حدث خطأ في البحث');
                });
        }

        function searchImmobilized() {
            showLoading();
            
            const params = new URLSearchParams();
            const status = document.getElementById('immobilizedStatus').value;
            const paymentStatus = document.getElementById('paymentStatus').value;
            
            if (status) params.append('status', status);
            if (paymentStatus) params.append('payment_status', paymentStatus);
            
            fetch(`/api/immobilized-cars?${params}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.immobilized_cars) {
                        displayImmobilizedResults(data.immobilized_cars);
                    } else {
                        showError('فشل في جلب بيانات السيارات المحجوزة');
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showError('حدث خطأ في البحث');
                });
        }

        // Display functions
        function displayVehiclesResults(vehicles) {
            if (!vehicles || vehicles.length === 0) {
                showNoResults();
                return;
            }

            document.getElementById('resultsCount').textContent = `عدد النتائج: ${vehicles.length}`;
            
            const table = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم اللوحة</th>
                                <th>المالك</th>
                                <th>الماركة</th>
                                <th>الموديل</th>
                                <th>السنة</th>
                                <th>اللون</th>
                                <th>عدد المخالفات</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vehicles.map(vehicle => `
                                <tr>
                                    <td><strong>${vehicle.plate_number || 'غير محدد'}</strong></td>
                                    <td>${vehicle.owner_name || 'غير محدد'}</td>
                                    <td>${vehicle.make || 'غير محدد'}</td>
                                    <td>${vehicle.model || 'غير محدد'}</td>
                                    <td>${vehicle.year || '-'}</td>
                                    <td>${vehicle.color || '-'}</td>
                                    <td><strong style="color: ${(vehicle.violation_count || 0) > 0 ? '#ef4444' : '#10b981'}">
                                        ${vehicle.violation_count || 0}
                                    </strong></td>
                                    <td><span class="status-badge ${vehicle.is_active ? 'status-active' : 'status-pending'}">
                                        ${vehicle.is_active ? 'نشطة' : 'غير نشطة'}
                                    </span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('resultsContainer').innerHTML = table;
        }

        function displayAccidentsResults(accidents) {
            if (!accidents || accidents.length === 0) {
                showNoResults();
                return;
            }

            document.getElementById('resultsCount').textContent = `عدد النتائج: ${accidents.length}`;
            
            const table = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الحادث</th>
                                <th>التاريخ</th>
                                <th>الموقع</th>
                                <th>الخطورة</th>
                                <th>المركبات</th>
                                <th>الإصابات</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accidents.map(accident => {
                                const severityMap = {
                                    'minor': { text: 'بسيط', class: 'status-active' },
                                    'moderate': { text: 'متوسط', class: 'status-pending' },
                                    'severe': { text: 'خطير', class: 'status-critical' },
                                    'critical': { text: 'حرج', class: 'status-critical' }
                                };
                                const severity = severityMap[accident.severity] || { text: accident.severity, class: 'status-pending' };
                                
                                return `
                                    <tr>
                                        <td><strong>${accident.accident_number || 'غير محدد'}</strong></td>
                                        <td>${formatDate(accident.accident_date)}</td>
                                        <td>${accident.location || 'غير محدد'}</td>
                                        <td><span class="status-badge ${severity.class}">${severity.text}</span></td>
                                        <td>${accident.vehicles_involved || 0}</td>
                                        <td>${accident.injuries_count || 0}</td>
                                        <td><span class="status-badge status-pending">${accident.status || 'مبلغ عنه'}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('resultsContainer').innerHTML = table;
        }

        function displayImmobilizedResults(cars) {
            if (!cars || cars.length === 0) {
                showNoResults();
                return;
            }

            document.getElementById('resultsCount').textContent = `عدد النتائج: ${cars.length}`;
            
            const table = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم اللوحة</th>
                                <th>تاريخ الحجز</th>
                                <th>نوع الحجز</th>
                                <th>السبب</th>
                                <th>إجمالي الرسوم</th>
                                <th>حالة الدفع</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cars.map(car => `
                                <tr>
                                    <td><strong>${car.plate_number || 'غير محدد'}</strong></td>
                                    <td>${formatDate(car.immobilized_date)}</td>
                                    <td>${car.immobilization_type === 'boot' ? 'كبح' : 'سحب'}</td>
                                    <td>${car.reason || 'غير محدد'}</td>
                                    <td><strong>${formatCurrency(car.total_fees || 0)} ريال</strong></td>
                                    <td><span class="status-badge ${car.payment_status === 'paid' ? 'status-active' : 'status-critical'}">
                                        ${car.payment_status === 'paid' ? 'مدفوعة' : 'غير مدفوعة'}
                                    </span></td>
                                    <td><span class="status-badge ${car.status === 'released' ? 'status-active' : 'status-pending'}">
                                        ${car.status === 'released' ? 'مفرج عنها' : 'محجوزة'}
                                    </span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('resultsContainer').innerHTML = table;
        }

        // Utility functions
        function showLoading() {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>جاري البحث...</p>
                </div>
            `;
        }

        function showNoResults() {
            document.getElementById('resultsCount').textContent = 'لا توجد نتائج';
            document.getElementById('resultsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>لا توجد نتائج</h3>
                    <p>لم يتم العثور على أي بيانات تطابق معايير البحث</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i>
                    ${message}
                </div>
            `;
        }

        function showInfo(message) {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    ${message}
                </div>
            `;
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-SA').format(amount || 0);
        }

        function exportResults(format) {
            showAlert(`جاري تصدير النتائج بصيغة ${format}...`, 'info');
            // Implement export functionality
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.left = '50%';
            alert.style.transform = 'translateX(-50%)';
            alert.style.zIndex = '10000';
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>
